# Active Context

* **Current Focus:** Completed Anki ID format change and parser refactoring.
* **Recent Changes:**
    * Changed the Anki card ID format from `^1234567890` to HTML comment `<!-- ankiID: 1234567890 -->`.
        * Updated regexes in `src/conf/regex.ts` to detect/extract the new format.
        * Updated `getIdFormat()` in all `Card` subclasses (`src/entities/*.ts`) to generate the new format.
        * Updated `Parser.getAnkiIDsBlocks` (`src/services/parser.ts`) to find existing IDs using the new HTML comment format.
        * Updated `CardsService.writeAnkiBlocks` (`src/services/cards.ts`) to ensure the new ID is added on a newline (only adding the newline if one doesn't already precede the insertion point).
        * Updated deletion commands in `main.ts` to use the new ID regex and cleanup logic.
        * Refactored `Parser.generateCardsWithTag` (`src/services/parser.ts`): Simplified the `flashscardsWithTag` regex (`src/conf/regex.ts`) to only match the first line of a #card tag block. Implemented programmatic logic within `generateCardsWithTag` to iterate subsequent lines to find the answer content and optional ID block. This fixes a bug where cards (especially list items) at the end of the file might not be parsed if preceding cards had ID blocks.
        * Refactored `CardsService.filterByUpdate` to more reliably differentiate new cards from existing ones by cross-referencing parsed card IDs with the set of IDs actually found in the file, fixing a bug where new cards might not be created if other cards already had IDs.
    * Fixed image rendering for wikilinks with dimensions (e.g., `![[image.webp|100x100]]`).
        * Updated image regexes (`wikiImageLinks`, `markdownImageLinks` in `src/conf/regex.ts`) to support `webp` and `avif` formats and capture filename, width, and height separately.
        * Modified `substituteImageLinks` in `src/services/parser.ts` to generate correct `<img src='...' width='...' height='...'>` tags directly.
        * Added a cleanup step in `parseLine` (`src/services/parser.ts`) to remove potentially duplicated embed HTML (`<div class="internal-embed...">`) generated by `showdown` after the correct `<img>` tag.
    * Previous attempts using placeholders (`@@IMAGE::...@@`) failed due to complex interactions with `showdown` or placeholder mismatches.
* **Next Steps:** Awaiting user instructions for the next task. Populating core Memory Bank documents (`projectbrief.md`, `productContext.md`) is still pending.
* **Active Decisions:**
    * Adopted `<!-- ankiID: 1234567890 -->` as the new format for Anki card IDs to avoid conflicts with Obsidian block references (`^block-id`). Removed support for the old `^...` format.
    * Adopted a "direct generation + cleanup" approach for handling image links in the parser.
    * Extended supported image formats to include `webp` and `avif`.
* **Patterns & Preferences:**
    * Substitution logic is complex due to interactions with `showdown`. Final cleanup steps after `makeHtml` might be necessary for other complex syntax.
    * Regexes in `src/conf/regex.ts` need careful testing for edge cases (like dimensions/aliases).
* **Learnings & Insights:**
    * The `showdown` library (or Obsidian's use of it) can interfere with pre-processed HTML, potentially duplicating or re-interpreting structures derived from original Markdown syntax.
    * Placeholder strategies can be fragile if the placeholder format is modified by intermediate processing steps.
    * A direct generation followed by a targeted cleanup regex can be more robust for handling such interferences.
* **Implementation Details:**
    * Implemented command 'Delete all cards in current file from Anki only':
        * Deletes corresponding notes in Anki.
        * Removes Anki ID blocks (`^...` or `%%...%%`) from the current file in Obsidian using line filtering to preserve layout.
    * Implemented command 'Delete selected card(s) from Anki only':
        * Requires text selection.
        * Deletes corresponding notes in Anki for all IDs found in the selection.
        * Removes Anki ID blocks from the selection in Obsidian.
    * Added `CardsService.deleteCardsFromAnkiOnly(cardIds: number[])` to handle deletion via AnkiConnect.
    * Updated Anki ID detection regex to handle both `^...` and `%%...%%` formats.
* **Patterns & Preferences:**
    * Commands are added to `main.ts` using `addCommand` with an `editorCallback`.
    * Service logic is separated into `src/services/cards.ts`.
    * User notifications are provided via `new Notice()`.
    * Anki ID blocks are now in the format `<!-- ankiID: 1234567890 -->` and located on their own line following the card content.
* **Learnings & Insights:** 
    * Simple regex replace on file content can break formatting; line-based processing (split, filter, join) is safer for preserving layout when removing specific lines.
    * Standard card regex (`flashscardsWithTag`) needs to account for optional leading blockquote markers (`> `) to parse cards defined within callouts or blockquotes. 