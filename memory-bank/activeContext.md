# Active Context

* **Current Focus:** Completed image rendering fix.
* **Recent Changes:**
    * Fixed image rendering for wikilinks with dimensions (e.g., `![[image.webp|100x100]]`).
        * Updated image regexes (`wikiImageLinks`, `markdownImageLinks` in `src/conf/regex.ts`) to support `webp` and `avif` formats and capture filename, width, and height separately.
        * Modified `substituteImageLinks` in `src/services/parser.ts` to generate correct `<img src='...' width='...' height='...'>` tags directly.
        * Added a cleanup step in `parseLine` (`src/services/parser.ts`) to remove potentially duplicated embed HTML (`<div class="internal-embed...">`) generated by `showdown` after the correct `<img>` tag.
    * Previous attempts using placeholders (`@@IMAGE::...@@`) failed due to complex interactions with `showdown` or placeholder mismatches.
* **Next Steps:** Awaiting user instructions for the next task. Documenting project context (Brief, Product, System, Tech) is still pending.
* **Active Decisions:**
    * Adopted a "direct generation + cleanup" approach for handling image links in the parser.
    * Extended supported image formats to include `webp` and `avif`.
* **Patterns & Preferences:**
    * Substitution logic is complex due to interactions with `showdown`. Final cleanup steps after `makeHtml` might be necessary for other complex syntax.
    * Regexes in `src/conf/regex.ts` need careful testing for edge cases (like dimensions/aliases).
* **Learnings & Insights:**
    * The `showdown` library (or Obsidian's use of it) can interfere with pre-processed HTML, potentially duplicating or re-interpreting structures derived from original Markdown syntax.
    * Placeholder strategies can be fragile if the placeholder format is modified by intermediate processing steps.
    * A direct generation followed by a targeted cleanup regex can be more robust for handling such interferences.
* **Implementation Details:**
    * Implemented command 'Delete all cards in current file from Anki only':
        * Deletes corresponding notes in Anki.
        * Removes Anki ID blocks (`^...` or `%%...%%`) from the current file in Obsidian using line filtering to preserve layout.
    * Implemented command 'Delete selected card(s) from Anki only':
        * Requires text selection.
        * Deletes corresponding notes in Anki for all IDs found in the selection.
        * Removes Anki ID blocks from the selection in Obsidian.
    * Added `CardsService.deleteCardsFromAnkiOnly(cardIds: number[])` to handle deletion via AnkiConnect.
    * Updated Anki ID detection regex to handle both `^...` and `%%...%%` formats.
* **Patterns & Preferences:**
    * Commands are added to `main.ts` using `addCommand` with an `editorCallback`.
    * Service logic is separated into `src/services/cards.ts`.
    * User notifications are provided via `new Notice()`.
    * Anki ID blocks can be in `^\d+` or `%%anki ID: \d+%%` format.
* **Learnings & Insights:** 
    * Simple regex replace on file content can break formatting; line-based processing (split, filter, join) is safer for preserving layout when removing specific lines. 